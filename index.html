<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squat Master Mobile</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SquatMaster">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* „Çπ„Éû„ÉõÁî®„É™„Çª„ÉÉ„Éà & „Éï„Ç©„É≥„Éà */
        body { 
            margin: 0; padding: 0; background-color: #121212; 
            font-family: "Hiragino Kaku Gothic ProN", sans-serif; 
            overflow: hidden; touch-action: none; 
        }
        
        .container { 
            position: relative; width: 100vw; height: 100dvh; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #input_video { 
            position: absolute; width: 100%; height: 100%; 
            object-fit: cover; transform: scaleX(-1); z-index: 0;
        }
        #output_canvas { 
            position: absolute; width: 100%; height: 100%; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* === Â∑¶„Çµ„Ç§„Éâ: „Ç≤„Éº„Ç∏ & ÊÉÖÂ†±„Éë„Éç„É´ === */
        #depth-gauge-container {
            position: absolute; left: 15px; top: 25%; bottom: 25%; width: 30px;
            background: rgba(0, 0, 0, 0.5); border-radius: 15px; border: 2px solid #fff; 
            display: none;
        }
        #depth-bar { position: absolute; top: 0; left: 0; width: 100%; height: 0%; background: #00bcd4; transition: height 0.05s linear; }
        #target-line { position: absolute; left: 0; width: 100%; height: 4px; background: #ff4081; z-index: 5; }
        #target-label { position: absolute; left: 55px; color: #ff4081; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 0 black; display: none; }
        
        .info-panel {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0, 0, 0, 0.6); padding: 10px; border-radius: 10px;
            color: white; width: 110px; border: 1px solid #777;
        }
        .info-label { font-size: 11px; color: #ccc; }
        .info-val { font-size: 32px; font-weight: bold; line-height:1.0; }

        /* === Âè≥„Çµ„Ç§„Éâ: „Éö„Éº„Çµ„Éº & „Çø„Ç§„Éû„Éº/„Çπ„Ç≥„Ç¢ === */
        #pacer-container {
            position: absolute; right: 15px; top: 25%; bottom: 25%; width: 8px;
            background: rgba(255, 255, 255, 0.2); border-radius: 4px; 
            display: none;
        }
        #pacer-ghost {
            position: absolute; left: -16px; width: 40px; height: 40px;
            background: #2979ff; border: 3px solid white; border-radius: 50%; top: 100%;
            box-shadow: 0 0 15px #2979ff;
        }

        .timer-box {
            position: absolute; top: 15px; right: 15px; background: #000; color: #00e676;
            padding: 5px 15px; border-radius: 8px; font-size: 28px; font-weight: bold; border: 2px solid #00e676;
            display: none;
        }
        
        /* „Ç≤„Éº„É†UI */
        .score-board {
            position: absolute; top: 15px; right: 15px;
            text-align: right; width: auto;
        }
        .score-label { font-size: 12px; color: #ffd700; font-weight: bold; text-shadow: 1px 1px 0 #000; display: block; }
        .score-val { 
            font-size: 42px; font-weight: 900; color: #fff; 
            text-shadow: 0 0 10px #ffd700, 2px 2px 0 #000; font-style: italic; line-height: 1.0;
        }

        #battle-stage {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            width: 250px; text-align: center;
        }
        #monster-name {
            background: rgba(0,0,0,0.6); padding: 2px 10px; border-radius: 10px; 
            color: #00e676; font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 5px;
            border: 1px solid #00e676;
        }
        #monster { font-size: 80px; filter: drop-shadow(0 0 10px red); transition: transform 0.1s; display:inline-block; }
        
        .hp-container {
            width: 100%; height: 18px; background: #333; border: 2px solid white; border-radius: 10px;
            margin-top: 5px; overflow: hidden; position: relative;
        }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff1744, #ff4081); transition: width 0.3s; }
        #hp-text {
            position: absolute; top: 0; left: 0; width: 100%; text-align: center;
            font-size: 12px; font-weight: bold; color: white; line-height: 18px; text-shadow: 1px 1px 0 #000;
        }

        /* Ë≠¶Âëä & „Çπ„ÉÜ„Éº„Çø„Çπ */
        .warning-text {
            position: absolute; top: 55%; left: 50%; transform: translateX(-50%);
            font-size: 24px; font-weight: bold; color: #ff1744; 
            background: rgba(255, 255, 255, 0.95); padding: 10px 20px; border-radius: 10px; 
            border: 3px solid red; display: none; width: 80%; text-align: center;
        }
        
        .control-area {
            position: absolute; bottom: 10%; left: 0; width: 100%; text-align: center; pointer-events: auto;
        }
        .finish-btn {
            background: linear-gradient(45deg, #f44336, #ff9800); color: white; border: none;
            padding: 15px 60px; font-size: 22px; border-radius: 50px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer;
        }

        #combo-display {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) rotate(-5deg);
            font-size: 60px; font-weight: 900; color: #ffeb3b; 
            text-shadow: 3px 3px 0 #f57f17, -1px -1px 0 white;
            font-style: italic; pointer-events: none; opacity: 0;
            transition: transform 0.1s, opacity 0.3s; z-index: 20;
        }
        .combo-active { opacity: 1 !important; transform: translate(-50%, -50%) rotate(-5deg) scale(1.3) !important; }

        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #countdown-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 15; display: none;
            justify-content: center; align-items: center;
        }
        .countdown-text { font-size: 100px; font-weight: bold; color: white; text-shadow: 0 0 30px cyan; text-align: center;}

        /* „Çπ„Çø„Éº„Éà„Éª„É™„Ç∂„É´„ÉàÁîªÈù¢ */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; z-index: 20; display: flex; flex-direction: column; align-items: center; color: white;
            pointer-events: auto; overflow-y: auto; padding-top: 40px; padding-bottom: 40px;
        }
        
        #result-screen { display: none; padding: 20px; box-sizing: border-box; }

        /* ÂÖ±ÈÄö„Éú„Çø„É≥„Éá„Ç∂„Ç§„É≥ */
        .big-btn {
            width: 85%; padding: 25px; margin: 15px; border-radius: 15px; border: none;
            font-size: 24px; font-weight: bold; color: white; cursor: pointer; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.1s;
        }
        .btn-train { background: linear-gradient(135deg, #00c853, #64dd17); }
        .btn-game { background: linear-gradient(135deg, #2979ff, #00e5ff); }
        
        .sub-btn {
            width: 80%; padding: 15px; margin: 8px; border-radius: 10px; border: 2px solid #555;
            font-size: 18px; color: white; background: #333; cursor: pointer;
        }
        .sub-btn.selected { border-color: #00e676; background: #003300; }

        .input-area { padding: 15px; font-size: 20px; text-align: center; border-radius: 8px; width: 70%; margin-bottom: 20px;}

        /* „É™„Ç∂„É´„ÉàÁî® */
        .stat-card { background: #333; padding: 10px; border-radius: 10px; width: 45%; text-align: center; margin-bottom: 5px;}
        .stat-val { font-size: 28px; font-weight: bold; }
        .chart-box { width: 95%; max-width: 400px; height: 180px; background: white; border-radius: 8px; margin-bottom: 10px; }
        
        button.start-btn { background: #00e676; color: #003300; font-weight: bold; margin-top: 20px; padding: 15px; width: 80%; border:none; border-radius: 30px; font-size: 20px;}
        button.cloud-btn { background: #2962ff; color: white; width: 90%; padding: 15px; border-radius:30px; border:none; font-weight:bold; margin-top:10px;}
        button.dl-btn { background: #555; color: white; margin-top: 10px; font-size: 14px; padding: 10px; border-radius: 5px; border:none;}
        button.close-btn { background: #333; color: #aaa; margin-top: 30px; padding: 15px; font-size: 16px; border: 1px solid #555;}
        
        .damage-shake { animation: shake 0.3s; }
        @keyframes shake { 0% {transform: rotate(0deg);} 25% {transform: rotate(10deg);} 75% {transform: rotate(-10deg);} 100% {transform: rotate(0deg);} }
    </style>
</head>
<body>

    <div class="container">
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
        
        <div id="countdown-overlay"><div class="countdown-text" id="countdown-val">5</div></div>

        <div class="ui-layer">
            <div id="depth-gauge-container"><div id="depth-bar"></div><div id="target-line"></div></div>
            <div id="target-label">ÁõÆÊ®ô„É©„Ç§„É≥</div>
            <div id="pacer-container"><div id="pacer-ghost"></div></div>

            <div id="training-ui">
                <div class="info-panel">
                    <div class="info-label">ÂõûÊï∞</div><div class="info-val" id="tr-reps">0</div>
                    <div style="height:5px;"></div>
                    <div class="info-label">ÁßíÊï∞</div><div class="info-val" id="tr-speed">0.0</div>
                </div>
                <div class="timer-box" id="tr-timer">30</div>
            </div>

            <div id="game-ui">
                <div class="info-panel">
                    <div class="info-label">LEVEL</div><div class="info-val" id="gm-lvl-val">1</div>
                    <div style="height:5px;"></div>
                    <div class="info-label">COMBO</div><div class="info-val" id="gm-combo-val">0</div>
                </div>

                <div class="score-board">
                    <div class="score-label">SCORE</div>
                    <div class="score-val" id="gm-score">0</div>
                </div>

                <div id="battle-stage">
                    <div id="monster-name">Lv.1 „Çπ„É©„Ç§„É†</div><br>
                    <div id="monster">üëæ</div>
                    <div class="hp-container">
                        <div id="hp-bar"></div>
                        <div id="hp-text">100/100</div>
                    </div>
                </div>
                
                <div id="combo-display"></div>
            </div>

            <div class="warning-text" id="warning-msg"></div>
            
            <div class="control-area">
                <button class="finish-btn" onclick="finishSession()">ÁµÇ‰∫Ü</button>
            </div>
        </div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <h1 style="color:#00e676; text-shadow:0 0 10px green; margin-bottom:10px;">SQUAT MASTER</h1>
        <input type="text" id="patient-id" class="input-area" value="User01" placeholder="ID„ÇíÂÖ•Âäõ">
        
        <div id="main-menu" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <button class="big-btn btn-train" onclick="selectCategory('training')">
                <div>üèãÔ∏è „Éà„É¨„Éº„Éã„É≥„Ç∞</div>
                <div style="font-size:14px; font-weight:normal; margin-top:5px;">„Çπ„É≠„Éà„É¨ / „Çª„É´„Éï / CS-30</div>
            </button>
            <button class="big-btn btn-game" onclick="selectCategory('game')">
                <div>‚öîÔ∏è „Ç≤„Éº„É†„É¢„Éº„Éâ</div>
                <div style="font-size:14px; font-weight:normal; margin-top:5px;">„É¢„É≥„Çπ„Çø„Éº„ÇíÂÄí„Åó„Å¶„Çπ„Ç≥„Ç¢„ÇíÁ´∂„ÅÜ</div>
            </button>
        </div>

        <div id="train-menu" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <h3 style="color:#ccc;">„É°„Éã„É•„Éº„ÇíÈÅ∏Êäû</h3>
            <button class="sub-btn selected" id="opt-slow" onclick="setTrainMode('slow')">üê¢ „Çπ„É≠„Éº„Éà„É¨„Éº„Éã„É≥„Ç∞ (7Áßí)</button>
            <button class="sub-btn" id="opt-self" onclick="setTrainMode('self')">üôÇ „Çª„É´„Éï„Éö„Éº„Çπ</button>
            <button class="sub-btn" id="opt-cs30" onclick="setTrainMode('cs30')">‚è± CS-30 „ÉÜ„Çπ„Éà</button>
            
            <button class="start-btn" onclick="startApp()">Ê∏¨ÂÆö„Çπ„Çø„Éº„Éà</button>
            <button onclick="backToMain()" style="background:transparent; border:none; color:#aaa; margin-top:20px;">Êàª„Çã</button>
        </div>
    </div>

    <div id="result-screen" class="overlay-screen">
        <h2 style="color:white; border-bottom:2px solid #00e676;">RESULT</h2>
        
        <div id="game-result-area" style="display:none; text-align:center; margin-bottom:10px;">
            <div style="font-size:60px; font-weight:900; color:#ffd700;" id="res-rank">S</div>
            <div style="color:#ffeb3b; font-size:24px;">SCORE: <span id="res-score-final">0</span></div>
        </div>

        <div style="display:flex; justify-content:space-between; width:95%; max-width:400px;">
            <div class="stat-card"><div style="font-size:12px;">ÂõûÊï∞</div><div class="stat-val" id="res-reps">0</div></div>
            <div class="stat-card"><div style="font-size:12px;">Áñ≤Âä¥ÊåáÊï∞</div><div class="stat-val" id="res-fatigue">--</div></div>
        </div>

        <div style="width:100%; max-width:400px; margin-top:10px;">
            <div style="font-size:12px; color:#aaa;">‚ñº „Çπ„Éî„Éº„ÉâÊé®Áßª</div>
            <div class="chart-box"><canvas id="speedChart"></canvas></div>
            <div style="font-size:12px; color:#aaa;">‚ñº Ê∑±„Åï„Å®„Ç®„É©„Éº</div>
            <div class="chart-box"><canvas id="depthChart"></canvas></div>
        </div>

        <button class="cloud-btn" id="cloud-btn" onclick="sendToGoogleSheets()">„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò (DB)</button>
        
        <button class="dl-btn" onclick="downloadCSV()">CSV„Åß‰øùÂ≠ò (‰∫àÂÇô)</button>
        <button class="close-btn" onclick="location.reload()">„Çø„Ç§„Éà„É´„Å∏</button>
    </div>

<script>
    // 1. ÂÆöÊï∞ (URL„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈ†Ç„ÅÑ„Åü„Éï„Ç°„Ç§„É´„ÅÆ„ÇÇ„ÅÆ„Å´Êõ¥Êñ∞)
    const GAS_URL = "https://script.google.com/macros/s/AKfycby1toVXJVJ1HyMxWxue5U3IN2NjFud8JAMm_ze2J3eFtL0jkgXoCf1HRm3g_wA7PDPa/exec";
    
    const KNEE_IN_THRESHOLD = 0.04; 
    const BAD_POSTURE_ANGLE = 75;
    const RESET_ANGLE = 160;   
    const DEPTH_THRESHOLD = 130; 
    const SPEECH_COOLDOWN = 3000; 
    const SLOW_CYCLE_MS = 7000;
    const MONSTERS = [["üëæ", 300], ["ü¶á", 500], ["üëª", 800], ["üëπ", 1200], ["üê≤", 2000]];

    // 2. Â§âÊï∞
    let appState = {
        mode: "", subMode: "", isRunning: false, isFinished: false, isCameraReady: false,
        startTime: null, repStart: 0, patientID: "Guest"
    };
    let metrics = {
        count: 0, minAngle: 180, isDeep: false, isMoving: false, isClean: true,
        score: 0, combo: 0, maxCombo: 0, monsterLevel: 0, monsterHP: 0, defeated: 0, logs: []
    };
    let audioCtx = null;
    let lastSpeechTime = 0; 

    // 3. UI Helper
    function getEl(id) { return document.getElementById(id); }
    
    // 4. DOM Elements
    const videoElement = getEl('input_video');
    const canvasElement = getEl('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    const els = {
        uiTraining: getEl('training-ui'),
        uiGame: getEl('game-ui'),
        depthGaugeContainer: getEl('depth-gauge-container'),
        depthBar: getEl('depth-bar'),
        targetLine: getEl('target-line'),
        targetLabel: getEl('target-label'),
        pacerGhost: getEl('pacer-ghost'),
        pacerContainer: getEl('pacer-container'),
        warningMsg: getEl('warning-msg'),
        
        trReps: getEl('tr-reps'), trSpeed: getEl('tr-speed'), trTimer: getEl('tr-timer'),
        
        gmScore: getEl('gm-score'), monster: getEl('monster'), hpBar: getEl('hp-bar'),
        hpText: getEl('hp-text'), monsterName: getEl('monster-name'),
        gmComboVal: getEl('gm-combo-val'), gmLvlVal: getEl('gm-lvl-val'),
        comboDisp: getEl('combo-display'),
        
        countOverlay: getEl('countdown-overlay'), countVal: getEl('countdown-val'),
        startScreen: getEl('start-screen'), resScreen: getEl('result-screen')
    };

    // 5. Audio & Helpers
    function initAudio() {
        if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playTone(freq, type, dur) {
        if(!audioCtx) return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type=type; o.frequency.value=freq; g.gain.value=0.1;
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime+dur);
    }
    function playSound(type) {
        if(!audioCtx) return;
        if(type==='hit') { playTone(400,'square',0.1); setTimeout(()=>playTone(600,'square',0.1),50); }
        if(type==='crit') { playTone(880,'sine',0.1); setTimeout(()=>playTone(1760,'sine',0.2),50); }
        if(type==='win') { playTone(523,'triangle',0.2); setTimeout(()=>playTone(659,'triangle',0.1),100); setTimeout(()=>playTone(784,'triangle',0.4),200); }
        if(type==='error') playTone(150,'sawtooth',0.3);
        if(type==='count') playTone(600,'square',0.05);
        if(type==='start') { playTone(600,'square',0.1); setTimeout(()=>playTone(1200,'square',0.1),100); }
        if(type==='combo') {
            let base = 440 + (metrics.combo * 50); if(base>1200)base=1200;
            playTone(base,'triangle',0.1);
        }
    }
    function speak(text, force = false) {
        const now = Date.now();
        if (force || (now - lastSpeechTime > SPEECH_COOLDOWN)) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP'; uttr.rate = 1.2;
            window.speechSynthesis.speak(uttr);
            lastSpeechTime = now;
        }
    }
    function getNowStr() { return new Date().toLocaleString(); }
    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
    }
    function fireConfetti() { confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 }, colors: ['#ffd700', '#00e676', '#2979ff'] }); }
    function showComboEffect(val) {
        els.comboDisp.innerText = val + " COMBO!";
        els.comboDisp.classList.add("combo-active");
        playSound('combo');
        setTimeout(() => els.comboDisp.classList.remove("combo-active"), 800);
    }
    
    function updateScore(val) { metrics.score += val; els.gmScore.innerText = metrics.score; }
    
    function spawnMonster() {
        let lv = metrics.monsterLevel;
        if(lv >= MONSTERS.length) lv = MONSTERS.length - 1;
        const m = MONSTERS[lv];
        els.monster.innerText = m[0];
        els.monsterName.innerText = `Lv.${lv+1} ${m[1]}`;
        metrics.monsterHP = m[1];
        updateHP(m[1], m[1]);
        els.gmLvlVal.innerText = lv + 1;
    }
    
    function updateHP(cur, max) { 
        const p = (cur / max) * 100; 
        els.hpBar.style.width = p + "%";
        els.hpText.innerText = `${cur} / ${max}`;
    }
    
    function damageEffect(dmg, isCrit) {
        metrics.monsterHP -= dmg;
        if(metrics.monsterHP < 0) metrics.monsterHP = 0;
        updateHP(metrics.monsterHP, MONSTERS[Math.min(metrics.monsterLevel, 4)][1]);
        
        els.monster.classList.remove('damage-shake');
        void els.monster.offsetWidth; els.monster.classList.add('damage-shake');
        if(isCrit) { playSound('crit'); fireConfetti(); } else { playSound('hit'); }
        if(metrics.monsterHP <= 0) {
            setTimeout(() => {
                playSound('win'); speak("ÊíÉÁ†¥ÔºÅ");
                metrics.monsterLevel++; metrics.defeated++; spawnMonster();
            }, 500);
        }
    }

    // 6. UI Control
    function selectCategory(cat) {
        appState.mode = cat;
        if(cat === 'game') {
            startAppLogic();
        } else {
            getEl('main-menu').style.display = 'none';
            getEl('train-menu').style.display = 'flex';
            setTrainMode('slow'); 
        }
    }
    function setTrainMode(mode) {
        appState.subMode = mode;
        ['slow','self','cs30'].forEach(m => getEl('opt-'+m).classList.remove('selected'));
        getEl('opt-'+mode).classList.add('selected');
    }
    function backToMain() {
        getEl('train-menu').style.display = 'none';
        getEl('main-menu').style.display = 'flex';
    }
    function startApp() { startAppLogic(); }
    
    function startAppLogic() {
        appState.patientID = getEl('patient-id').value || "Guest";
        els.startScreen.style.display = 'none';
        
        // Mode Init
        if(appState.mode === 'training') {
            els.uiTraining.style.display = 'block';
            els.uiGame.style.display = 'none';
            if(appState.subMode === 'cs30') {
                els.trTimer.style.display = 'block'; els.pacerContainer.style.display = 'none';
            } else if(appState.subMode === 'slow') {
                els.pacerContainer.style.display = 'block';
                els.pacerGhost.style.top = "100%";
            } else {
                els.pacerContainer.style.display = 'block';
            }
        } else {
            els.uiTraining.style.display = 'none';
            els.uiGame.style.display = 'block';
            els.pacerContainer.style.display = 'block';
            spawnMonster();
        }

        initAudio();
        speak("„Ç´„É°„É©„ÇíËµ∑Âãï„Åó„Åæ„Åô");
        const camera = new Camera(videoElement, {
            onFrame: async () => { if(!appState.isFinished) await pose.send({image: videoElement}); },
            width: 1280, height: 720
        });
        camera.start();
        animatePacerLoop();
    }

    function updateGauge(angle) {
        const min=180, max=70;
        let p = (min - angle) / (min - max) * 100;
        if(p<0)p=0; if(p>100)p=100;
        els.depthBar.style.height = p + "%";
        els.depthBar.style.backgroundColor = (angle < DEPTH_THRESHOLD) ? "#00e676" : "#00bcd4";
        let tp = (min - DEPTH_THRESHOLD) / (min - max) * 100;
        els.targetLine.style.top = tp + "%"; 
        if(appState.subMode !== 'slow' && appState.mode !== 'cs30') els.pacerGhost.style.top = p + "%";
    }

    function animatePacerLoop() {
        if(!appState.isFinished) {
            if(appState.subMode === 'slow' && appState.isRunning) {
                const t = (Date.now() - appState.startTime) % SLOW_CYCLE_MS;
                let pos = 0;
                if(t < 3000) pos = 100 - (t/3000*100);
                else if(t < 6000) pos = (t-3000)/3000*100;
                else pos = 100;
                els.pacerGhost.style.top = pos + "%";
            }
            requestAnimationFrame(animatePacerLoop);
        }
    }

    function runCountdown() {
        let c = 5;
        els.countOverlay.style.display = 'flex';
        if(appState.subMode === 'slow') {
            els.countVal.innerText = "„Åó„ÇÉ„Åå„Çì„ÅßÔºÅ"; els.countVal.style.fontSize = "60px";
            speak("„Åó„ÇÉ„Åå„Çì„ÅßÊ∫ñÂÇô"); els.pacerGhost.style.top = "100%";
        } else {
            els.countVal.innerText = c; els.countVal.style.fontSize = "120px";
            speak(String(c), true); playSound('count');
        }
        setTimeout(() => {
            if(appState.subMode==='slow') { c=5; els.countVal.style.fontSize="120px"; }
            const timer = setInterval(() => {
                els.countVal.innerText = c;
                speak(String(c), true);
                if(c<=3) playSound('count');
                c--;
                if(c < 0) {
                    clearInterval(timer);
                    els.countVal.innerText = "START!";
                    speak("„Çπ„Çø„Éº„Éà", true);
                    playSound('start');
                    setTimeout(() => {
                        els.countOverlay.style.display = 'none';
                        appState.startTime = Date.now();
                        appState.isRunning = true;
                    }, 1000);
                }
            }, 1000);
        }, 1500);
    }

    function finishSession() {
        appState.isFinished = true;
        appState.isRunning = false;
        speak("ÁµÇ‰∫Ü„Åß„Åô"); playSound('win');
        document.querySelector('.container').style.display = 'none';
        els.resScreen.style.display = 'flex';
        getEl('res-reps').innerText = metrics.count;
        if(appState.mode === 'game') {
            getEl('game-result-area').style.display = 'block';
            getEl('res-score-final').innerText = metrics.score;
            let r = "B";
            if(metrics.score > metrics.count * 120) r = "S"; else if(metrics.score > metrics.count * 100) r = "A";
            getEl('res-rank').innerText = r;
        }
        const lbls = metrics.logs.map(d => d.rep);
        const spds = metrics.logs.map(d => d.duration);
        const dpts = metrics.logs.map(d => d.depth);
        const clrs = metrics.logs.map(d => (d.note==="Perfect")?'#00e676':'#ff1744');
        new Chart(getEl('speedChart'), {type:'line', data:{labels:lbls, datasets:[{label:'ÁßíÊï∞', data:spds, borderColor:'#00e676', tension:0.3}] }});
        new Chart(getEl('depthChart'), {type:'bar', data:{labels:lbls, datasets:[{label:'Ê∑±„Åï', data:dpts, backgroundColor:clrs}]}, options:{scales:{y:{reverse:true, min:60, max:180}}, plugins:{legend:{display:false}}}});
    }

    // ‚òÖ‰øÆÊ≠£: Summary/Details ÂØæÂøú„ÅÆÈÄÅ‰ø°„É≠„Ç∏„ÉÉ„ÇØ
    function sendToGoogleSheets() {
        if(metrics.logs.length===0){alert("„Éá„Éº„Çø„Å™„Åó");return;}
        const btn=getEl('cloud-btn'); btn.innerText="ÈÄÅ‰ø°‰∏≠..."; btn.disabled=true;
        
        const sessionID = appState.patientID + "_" + Date.now();
        const fatigue = getEl('res-fatigue').innerText;
        
        const payload = {
            sessionID: sessionID,
            summary: {
                patientID: appState.patientID,
                date: getNowStr(),
                mode: appState.mode + "_" + appState.subMode,
                reps: metrics.count,
                score: metrics.score,
                maxCombo: metrics.maxCombo,
                fatigue: fatigue
            },
            logs: metrics.logs
        };

        fetch(GAS_URL, {method:'POST', body:JSON.stringify(payload), headers:{"Content-Type":"text/plain"}})
        .then(()=>{alert("ÂÆå‰∫Ü"); btn.innerText="ÈÄÅ‰ø°ÂÆå‰∫Ü";})
        .catch(e=>{alert("„Ç®„É©„Éº: " + e); btn.disabled=false;});
    }

    function downloadCSV() {
        let c = "ID,Time,Rep,Depth,Duration,Note\n";
        metrics.logs.forEach(r => c += `${r.id},${r.time},${r.rep},${r.depth},${r.duration},${r.note}\n`);
        const a = document.createElement("a");
        a.href = encodeURI("data:text/csv;charset=utf-8,"+c);
        a.download = "log.csv"; a.click();
    }

    // 7. MediaPipe Main Loop
    function onResults(results) {
        if(appState.isFinished) return;

        if(!appState.isCameraReady) {
            appState.isCameraReady = true;
            els.depthGaugeContainer.style.display = 'block';
            els.targetLabel.style.display = 'block';
            
            if(appState.mode === 'training') {
                if(appState.subMode==='cs30') { /* Timer */ }
                else if(appState.subMode==='slow') els.pacerContainer.style.display='block';
                else els.pacerContainer.style.display='block';
            } else {
                els.pacerContainer.style.display='block';
            }

            const needsCount = (appState.mode==='game' || appState.subMode==='cs30' || appState.subMode==='slow');
            if(needsCount) runCountdown();
            else {
                appState.startTime = Date.now();
                appState.isRunning = true;
                speak("„Çπ„Çø„Éº„Éà");
            }
        }

        const w = videoElement.videoWidth;
        const h = videoElement.videoHeight;
        canvasElement.width = w; canvasElement.height = h;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, w, h);

        if (results.poseLandmarks) {
            const lms = results.poseLandmarks;
            drawConnectors(canvasCtx, lms, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(canvasCtx, lms, {color: '#FF0000', lineWidth: 2});

            let side = "RIGHT";
            if (lms[11].visibility > lms[12].visibility) side = "LEFT";
            let sIdx=(side==="RIGHT")?12:11, hIdx=(side==="RIGHT")?24:23, kIdx=(side==="RIGHT")?26:25, aIdx=(side==="RIGHT")?28:27;
            const shoulder=lms[sIdx], hip=lms[hIdx], knee=lms[kIdx], ankle=lms[aIdx];

            if(shoulder.visibility > 0.5 && hip.visibility > 0.5) {
                const kneeAngle = calculateAngle(hip, knee, ankle);
                const hipAngle = calculateAngle(shoulder, hip, knee);
                updateGauge(kneeAngle);
                
                canvasCtx.beginPath();
                canvasCtx.moveTo(shoulder.x*w, shoulder.y*h);
                canvasCtx.lineTo(hip.x*w, hip.y*h);
                canvasCtx.lineTo(knee.x*w, knee.y*h);
                canvasCtx.strokeStyle = "yellow"; canvasCtx.lineWidth = 5; canvasCtx.stroke();

                let warning=""; let isKneeIn=false;
                if(side==="RIGHT" && knee.x > ankle.x + KNEE_IN_THRESHOLD) isKneeIn=true;
                if(side==="LEFT" && knee.x < ankle.x - KNEE_IN_THRESHOLD) isKneeIn=true;

                if(isKneeIn && kneeAngle < 160) {
                    if(metrics.isMoving && metrics.isClean) {
                        warning="„Å≤„Åñ„ÇíÈñã„ÅÑ„Å¶ÔºÅ"; metrics.isClean=false; speak("„Å≤„Åñ"); playSound('error');
                    }
                }
                if(hipAngle < BAD_POSTURE_ANGLE && kneeAngle < 160) {
                    if(metrics.isMoving && metrics.isClean) {
                        warning="ËÉ∏„ÇíÂºµ„Å£„Å¶ÔºÅ"; metrics.isClean=false; speak("„ÇÄ„Å≠"); playSound('error');
                    }
                }
                
                if(warning) { els.warningMsg.innerText=warning; els.warningMsg.style.display='block'; }
                else { els.warningMsg.style.display='none'; }

                if(appState.isRunning) {
                    if(kneeAngle < 165 && !metrics.isMoving) {
                        metrics.isMoving=true; appState.repStart=Date.now(); metrics.minAngle=180;
                        metrics.isDeep=false; metrics.isClean=true; hasSpokenGood=false;
                    }
                    if(metrics.isMoving) {
                        if(kneeAngle < metrics.minAngle) metrics.minAngle = kneeAngle;
                        if(kneeAngle < DEPTH_THRESHOLD) {
                            metrics.isDeep=true;
                            if(!hasSpokenGood && metrics.isClean) { hasSpokenGood=true; }
                        }
                        if(kneeAngle > RESET_ANGLE) {
                            if(metrics.isDeep) {
                                metrics.count++;
                                const duration = (Date.now()-appState.repStart)/1000;
                                if(appState.mode==='training') {
                                    els.trReps.innerText=metrics.count; els.trSpeed.innerText=duration.toFixed(2);
                                    if(metrics.isClean) speak("OK", true);
                                } else {
                                    let damage=0, isCrit=false;
                                    if(metrics.isClean) {
                                        metrics.combo++; if(metrics.combo>metrics.maxCombo) metrics.maxCombo=metrics.combo;
                                        if(metrics.minAngle<100) { damage=150+metrics.combo*10; isCrit=true; }
                                        else { damage=100+metrics.combo*5; }
                                        updateScore(damage); showComboEffect(metrics.combo);
                                    } else {
                                        metrics.combo=0; damage=10; updateScore(10); speak("„Åä„Åó„ÅÑ");
                                    }
                                    damageEffect(damage, isCrit);
                                    els.gmComboVal.innerText = metrics.combo;
                                }
                                metrics.logs.push({
                                    id: appState.patientID, time: getNowStr(),
                                    rep: metrics.count, depth: Math.floor(metrics.minAngle),
                                    duration: parseFloat(duration.toFixed(2)), note: metrics.isClean?"Perfect":"Error"
                                });
                            }
                            metrics.isMoving=false; metrics.isDeep=false;
                        }
                    }
                }
            }
        }

        if(appState.subMode==='cs30' && appState.isRunning && !appState.isFinished) {
            const elap = (Date.now()-appState.startTime)/1000;
            let rem = 30-elap;
            if(rem<=0) { rem=0; finishSession(); }
            els.trTimer.innerText = Math.ceil(rem);
        }
        canvasCtx.restore();
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    pose.onResults(onResults);
</script>
</body>
</html>
