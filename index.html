<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squat Master v9.1 (Fixed)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* Base */
        body { margin: 0; padding: 0; background-color: #121212; font-family: "Hiragino Kaku Gothic ProN", sans-serif; overflow: hidden; touch-action: manipulation; }
        .container { position: relative; width: 100vw; height: 100dvh; padding-bottom: env(safe-area-inset-bottom); }
        #input_video { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 0; }
        #output_canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 1; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* === ÂÖ±ÈÄö„Éë„Éº„ÉÑ === */
        .control-area { position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center; pointer-events: auto; }
        .finish-btn { background: linear-gradient(45deg, #f44336, #ff9800); color: white; border: none; padding: 15px 60px; font-size: 22px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.6); cursor: pointer; }
        .warning-text { position: absolute; top: 55%; left: 50%; transform: translateX(-50%); font-size: 24px; font-weight: bold; color: #ff1744; background: rgba(255,255,255,0.95); padding: 10px 20px; border-radius: 10px; border: 3px solid red; display: none; width: 80%; text-align: center; z-index: 50; }
        .status-lamp { position: absolute; bottom: 100px; right: 20px; padding: 10px; border-radius: 10px; font-size: 16px; font-weight: bold; color: white; text-align: center; width: 80px; }
        .lamp-ready { background-color: #00e676; box-shadow: 0 0 15px #00e676; }
        .lamp-squat { background-color: #555; }

        /* === „Çπ„ÇØ„ÉØ„ÉÉ„ÉàÁî®UI === */
        #squat-ui { display: none; }
        #depth-gauge-container { position: absolute; left: 15px; top: 25%; bottom: 25%; width: 30px; background: rgba(0,0,0,0.5); border-radius: 15px; border: 2px solid #fff; }
        #depth-bar { position: absolute; top: 0; left: 0; width: 100%; height: 0%; background: #00bcd4; transition: height 0.05s linear; }
        #target-line { position: absolute; left: 0; width: 100%; height: 4px; background: #ff4081; z-index: 5; }
        #target-label { position: absolute; left: 55px; color: #ff4081; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 0 black; }
        #pacer-container { position: absolute; right: 15px; top: 25%; bottom: 25%; width: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; }
        #pacer-ghost { position: absolute; left: -16px; width: 40px; height: 40px; background: #2979ff; border: 3px solid white; border-radius: 50%; top: 100%; box-shadow: 0 0 15px #2979ff; }
        
        /* „Éà„É¨„Éº„Éã„É≥„Ç∞„É¢„Éº„ÉâÁî® */
        #training-info { display: none; }
        .info-panel { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px; color: white; width: 110px; border: 1px solid #777; pointer-events: auto; }
        .info-label { font-size: 11px; color: #ccc; }
        .info-val { font-size: 32px; font-weight: bold; line-height:1.0; }
        .timer-box { position: absolute; top: 15px; right: 15px; background: #000; color: #00e676; padding: 5px 15px; border-radius: 8px; font-size: 28px; font-weight: bold; border: 2px solid #00e676; display: none; }
        .pacer-counter { position: absolute; bottom: 120px; right: 60px; background: rgba(41, 121, 255, 0.8); padding: 5px 10px; border-radius: 8px; color: white; text-align: center; display: none; width: 80px; font-size: 12px; }
        
        /* „Ç≤„Éº„É†„É¢„Éº„ÉâÁî® */
        #game-info { display: none; }
        .game-header-L { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 10px; color: white; border: 1px solid #ffd700; }
        .game-header-R { position: absolute; top: 15px; right: 15px; text-align: right; }
        .score-label { font-size: 12px; color: #ffd700; font-weight: bold; display: block; }
        .score-val { font-size: 42px; font-weight: 900; color: #fff; text-shadow: 0 0 10px #ffd700, 2px 2px 0 #000; font-style: italic; line-height: 1.0; }
        #battle-stage { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); width: 250px; text-align: center; }
        #monster-name { background: rgba(0,0,0,0.6); padding: 2px 10px; border-radius: 10px; color: #00e676; font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 5px; border: 1px solid #00e676; }
        #monster { font-size: 100px; filter: drop-shadow(0 0 10px red); transition: transform 0.1s; display:inline-block; }
        .hp-container { width: 100%; height: 18px; background: #333; border: 2px solid white; border-radius: 10px; margin-top: 5px; overflow: hidden; position: relative; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff1744, #ff4081); transition: width 0.3s; }
        #hp-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 12px; font-weight: bold; color: white; line-height: 18px; text-shadow: 1px 1px 0 #000; }
        .damage-shake { animation: shake 0.3s; }
        @keyframes shake { 0% {transform: rotate(0deg);} 25% {transform: rotate(10deg);} 75% {transform: rotate(-10deg);} 100% {transform: rotate(0deg);} }
        #combo-display { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) rotate(-5deg); font-size: 60px; font-weight: 900; color: #ffeb3b; text-shadow: 3px 3px 0 #f57f17, -1px -1px 0 white; font-style: italic; pointer-events: none; opacity: 0; transition: transform 0.1s, opacity 0.3s; z-index: 20; }
        .combo-active { opacity: 1 !important; transform: translate(-50%, -50%) rotate(-5deg) scale(1.3) !important; }

        /* === „Éê„É©„É≥„ÇπÁî®UI === */
        #balance-ui { display: none; }
        .balance-timer-main { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 80px; font-weight: 900; color: #fff; text-shadow: 0 0 20px #00bcd4; text-align: center; }
        .balance-msg { font-size: 24px; color: #00e676; margin-top: 10px; }

        /* === „Éê„É≥„Ç∂„Ç§Áî®UI === */
        #banzai-ui { display: none; }
        .banzai-gauge { position: absolute; bottom: 20%; width: 40px; height: 40%; background: rgba(50, 50, 50, 0.6); border: 2px solid #fff; border-radius: 20px; overflow: hidden; }
        #banzai-gauge-L { left: 20px; }
        #banzai-gauge-R { right: 20px; }
        .banzai-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; transition: height 0.1s; }
        #banzai-bar-L { background: #ff4081; }
        #banzai-bar-R { background: #2979ff; }
        .banzai-text { position: absolute; bottom: 14%; font-size: 28px; font-weight: bold; color: white; text-shadow: 1px 1px 0 black; }
        #bz-angle-l { left: 20px; color: #ff4081; }
        #bz-angle-r { right: 20px; color: #2979ff; }
        .banzai-guide-text { position: absolute; top: 15%; width: 100%; text-align: center; font-size: 20px; color: #aaa; }

        /* Overlays */
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 20; display: flex; flex-direction: column; align-items: center; color: white; pointer-events: auto; overflow-y: auto; padding-top: 40px; padding-bottom: 60px; }
        #countdown-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 15; display: none; justify-content: center; align-items: center; }
        .countdown-text { font-size: 100px; font-weight: bold; color: white; text-shadow: 0 0 30px cyan; text-align: center;}

        /* Survey */
        #survey-screen { display: none; }
        .survey-card { background: #333; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; margin-bottom: 20px; text-align: center; border: 1px solid #444; }
        .survey-label { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: block; color:#00e676; }
        input[type=range] { width: 100%; margin: 15px 0; }
        .rpe-scale { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; }
        .rpe-val { font-size: 40px; font-weight: bold; color: #fff; }
        .pain-btn { background: #444; border: 1px solid #777; color: #fff; padding: 12px 20px; margin: 5px; border-radius: 20px; font-size: 16px; min-width: 70px; }
        .pain-btn.active { background: #ff1744; border-color: red; font-weight: bold; }
        button.survey-done-btn { background: #2979ff; color: white; padding: 15px 50px; border-radius: 30px; border:none; font-size: 20px; font-weight: bold; margin-top: 20px; }

        /* Result */
        #result-screen { display: none; }
        .stat-card { background: #333; padding: 10px; border-radius: 10px; width: 45%; text-align: center; margin-bottom: 5px; }
        .stat-val { font-size: 28px; font-weight: bold; }
        .chart-box { width: 95%; max-width: 400px; height: 180px; background: white; border-radius: 8px; margin-bottom: 10px; }

        /* Buttons */
        .big-btn { width: 85%; padding: 25px; margin: 15px; border-radius: 15px; border: none; font-size: 24px; font-weight: bold; color: white; cursor: pointer; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .btn-squat { background: linear-gradient(135deg, #00c853, #64dd17); }
        .btn-measure { background: linear-gradient(135deg, #2979ff, #00e5ff); }
        
        .sub-btn { width: 80%; padding: 15px; margin: 8px; border-radius: 10px; border: 2px solid #555; font-size: 18px; color: white; background: #333; cursor: pointer; }
        .sub-btn.selected { border-color: #00e676; background: #003300; }
        .input-area { padding: 15px; font-size: 20px; text-align: center; border-radius: 8px; width: 70%; margin-bottom: 20px;}
        
        button.start-btn { background: #00e676; color: #003300; font-weight: bold; margin-top: 20px; padding: 15px; width: 80%; border:none; border-radius: 30px; font-size: 20px;}
        button.cloud-btn { background: #2962ff; color: white; width: 90%; padding: 15px; border-radius:30px; border:none; font-weight:bold; margin-top:10px;}
        button.dl-btn { background: #555; color: white; margin-top: 10px; font-size: 14px; padding: 10px; border-radius: 5px; border:none;}
        button.close-btn { background: #333; color: #aaa; margin-top: 30px; padding: 15px; font-size: 16px; border: 1px solid #555;}
    </style>
</head>
<body>

    <div class="container">
        <video id="input_video" playsinline></video>
        <canvas id="output_canvas"></canvas>
        <div id="countdown-overlay"><div class="countdown-text" id="countdown-val">5</div></div>

        <div class="ui-layer">
            <div id="squat-ui">
                <div id="depth-gauge-container"><div id="depth-bar"></div><div id="target-line"></div></div>
                <div id="target-label">ÁõÆÊ®ô</div>
                <div id="pacer-container"><div id="pacer-ghost"></div></div>

                <div id="training-info">
                    <div class="info-panel">
                        <div class="info-label">ÂõûÊï∞</div><div class="info-val" id="tr-reps">0</div>
                        <div style="height:5px;"></div>
                        <div class="info-label">ÁßíÊï∞</div><div class="info-val" id="tr-speed">0.0</div>
                    </div>
                    <div class="timer-box" id="tr-timer">30</div>
                    <div class="pacer-counter" id="tr-pacer-box">
                        <div style="font-size:10px; color:#ccc;">„Éö„Éº„Çπ</div><div style="font-size:24px; font-weight:bold;" id="tr-pacer-val">0</div>
                    </div>
                </div>

                <div id="game-info">
                    <div class="game-header-L">
                        <div style="font-size:12px; color:#ccc;">LEVEL</div><div style="font-size:20px; font-weight:bold;" id="gm-lvl-val">1</div>
                        <div style="height:5px;"></div>
                        <div style="font-size:12px; color:#ccc;">COMBO</div><div style="font-size:24px; font-weight:bold; color:#ffeb3b;" id="gm-combo-val">0</div>
                    </div>
                    <div class="game-header-R">
                        <div class="score-label">SCORE</div><div class="score-val" id="gm-score">0</div>
                    </div>
                    <div id="battle-stage">
                        <div id="monster-name">Lv.1 „Çπ„É©„Ç§„É†</div><br>
                        <div id="monster">üëæ</div>
                        <div class="hp-container"><div id="hp-bar"></div><div id="hp-text">100/100</div></div>
                    </div>
                    <div id="combo-display"></div>
                </div>
            </div>

            <div id="balance-ui">
                <div class="balance-timer-main" id="bal-timer">0.00</div>
                <div class="balance-timer-main" style="font-size:20px; top:35%;" id="bal-status">‰∏°Ë∂≥ÁùÄÂú∞‰∏≠...</div>
                <div class="info-panel" style="top:auto; bottom:150px;">
                    <div class="info-label">„Éô„Çπ„ÉàË®òÈå≤</div><div class="info-val" id="bal-best">0.0</div>
                </div>
            </div>

            <div id="banzai-ui">
                <div class="banzai-guide-text">Ê≠£Èù¢„ÇíÂêë„ÅÑ„Å¶„Éê„É≥„Ç∂„Ç§ÔºÅ</div>
                <div class="banzai-gauge" id="banzai-gauge-L"><div class="banzai-bar" id="banzai-bar-L"></div></div>
                <div class="banzai-text" id="bz-angle-l">0¬∞</div>
                <div class="banzai-gauge" id="banzai-gauge-R"><div class="banzai-bar" id="banzai-bar-R"></div></div>
                <div class="banzai-text" id="bz-angle-r">0¬∞</div>
            </div>

            <div class="warning-text" id="warning-msg"></div>
            <div class="status-lamp lamp-squat" id="status-lamp">ÂæÖÊ©ü</div>
            <div class="control-area"><button class="finish-btn" onclick="finishSession()">ÁµÇ‰∫Ü</button></div>
        </div>
    </div>

    <div id="start-screen" class="overlay-screen">
        <h1 style="color:#00e676; text-shadow:0 0 10px green; margin-bottom:10px;">SQUAT MASTER</h1>
        <input type="text" id="patient-id" class="input-area" value="User01" placeholder="ID„ÇíÂÖ•Âäõ">
        
        <div id="main-menu" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <button class="big-btn btn-squat" onclick="selectCategory('squat')">
                <div>üèãÔ∏è „Çπ„ÇØ„ÉØ„ÉÉ„Éà</div><div style="font-size:14px; font-weight:normal; margin-top:5px;">„Çπ„É≠„Éà„É¨„Éª„Çª„É´„Éï„Éª„Ç≤„Éº„É†</div>
            </button>
            <button class="big-btn btn-measure" onclick="selectCategory('measure')">
                <div>üìä Ê∏¨ÂÆö („ÉÜ„Çπ„Éà)</div><div style="font-size:14px; font-weight:normal; margin-top:5px;">CS-30„Éª„Éê„É©„É≥„Çπ„Éª„Éê„É≥„Ç∂„Ç§</div>
            </button>
        </div>

        <div id="squat-menu" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <h3 style="color:#ccc;">„Çπ„ÇØ„ÉØ„ÉÉ„Éà („Éà„É¨„Éº„Éã„É≥„Ç∞)</h3>
            <button class="sub-btn selected" id="opt-slow" onclick="setSquatMode('slow')">üê¢ „Çπ„É≠„Éà„É¨ (7Áßí)</button>
            <button class="sub-btn" id="opt-self" onclick="setSquatMode('self')">üôÇ „Çª„É´„Éï„Éö„Éº„Çπ</button>
            <button class="sub-btn" id="opt-game" onclick="setSquatMode('game')">‚öîÔ∏è „Ç≤„Éº„É†„É¢„Éº„Éâ</button>
            
            <button class="start-btn" onclick="startApp()">„Çπ„Çø„Éº„Éà</button>
            <button onclick="backToMain()" style="background:transparent; border:none; color:#aaa; margin-top:20px;">Êàª„Çã</button>
        </div>
        
        <div id="measure-menu" style="display:none; width:100%; flex-direction:column; align-items:center;">
            <h3 style="color:#ccc;">Ê∏¨ÂÆö („ÉÜ„Çπ„Éà)</h3>
            <button class="sub-btn" id="opt-cs30" onclick="setMode('squat', 'cs30')">‚è± CS-30 (30ÁßíÁ´ã„Å°Â∫ß„Çä)</button>
            <button class="sub-btn" id="opt-balance" onclick="setMode('balance', 'normal')">ü¶© ÁâáË∂≥Á´ã„Å°„ÉÜ„Çπ„Éà</button>
            <button class="sub-btn" id="opt-banzai" onclick="setMode('banzai', 'normal')">üôÜ „Éê„É≥„Ç∂„Ç§ (ÂèØÂãïÂüü)</button>
            
            <button class="start-btn" onclick="startApp()">„Çπ„Çø„Éº„Éà</button>
            <button onclick="backToMain()" style="background:transparent; border:none; color:#aaa; margin-top:20px;">Êàª„Çã</button>
        </div>
    </div>

    <div id="survey-screen" class="overlay-screen">
        <h2 style="color:#00e676;">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</h2>
        <div class="survey-card">
            <span class="survey-label">Q1. „Åç„Å§„Åï„ÅØÔºü (0„Äú10)</span>
            <div class="rpe-val" id="rpe-val">3</div>
            <input type="range" id="rpe-slider" min="0" max="10" value="3" oninput="updateRPE(this.value)">
            <div class="rpe-scale"><span>Ê•Ω</span><span>ÊôÆÈÄö</span><span>„Åç„Å§„ÅÑ</span></div>
        </div>
        <div class="survey-card">
            <span class="survey-label">Q2. Áóõ„Åø„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü</span>
            <button class="pain-btn active" onclick="setPain('None', this)">„Å™„Åó</button>
            <button class="pain-btn" onclick="setPain('Knee', this)">ËÜù</button>
            <button class="pain-btn" onclick="setPain('Back', this)">ËÖ∞</button>
            <button class="pain-btn" onclick="setPain('Other', this)">‰ªñ</button>
        </div>
        <button class="survey-done-btn" onclick="submitSurvey()">ÁµêÊûú„ÇíË¶ã„Çã</button>
    </div>

    <div id="result-screen" class="overlay-screen">
        <h2 style="color:white; border-bottom:2px solid #00e676;">RESULT</h2>
        
        <div id="res-squat-area">
            <div id="game-result-area" style="display:none; text-align:center; margin-bottom:10px;">
                <div style="font-size:60px; font-weight:900; color:#ffd700;" id="res-rank">S</div>
                <div style="color:#ffeb3b; font-size:24px;">SCORE: <span id="res-score-final">0</span></div>
            </div>
            <div style="display:flex; justify-content:space-between; width:95%; max-width:400px;">
                <div class="stat-card"><div style="font-size:12px;">ÂõûÊï∞</div><div class="stat-val" id="res-reps">0</div></div>
                <div class="stat-card"><div style="font-size:12px;">Áñ≤Âä¥ÊåáÊï∞</div><div class="stat-val" id="res-fatigue">--</div></div>
            </div>
            <div style="width:100%; max-width:400px; margin-top:10px;">
                <div class="chart-box"><canvas id="speedChart"></canvas></div>
                <div class="chart-box"><canvas id="depthChart"></canvas></div>
            </div>
        </div>

        <div id="res-simple-area" style="display:none; text-align:center; width:100%;">
            <div style="font-size:20px; color:#aaa;" id="res-simple-label">Ë®òÈå≤</div>
            <div style="font-size:50px; font-weight:bold; color:#00e676;" id="res-simple-val">0</div>
        </div>

        <button class="cloud-btn" id="cloud-btn" onclick="sendToGoogleSheets()">„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò (DB)</button>
        <button class="dl-btn" onclick="downloadCSV()">CSV„Åß‰øùÂ≠ò</button>
        <button class="close-btn" onclick="location.reload()">„Çø„Ç§„Éà„É´„Å∏</button>
    </div>

<script>
    // URL„ÅØ„ÅîËá™Ë∫´„ÅÆ„ÇÇ„ÅÆ„Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyKqUnAi2JcfbQCzeI4498mTYEXFDCo1itE9pdnOQB9JJfyFHGvM4Z2SpkZsMjGRPsk/exec";
    
    const KNEE_IN_THRESHOLD = 0.04; 
    const BAD_POSTURE_ANGLE = 75;
    const RESET_ANGLE = 160;   
    const DEPTH_THRESHOLD = 130; 
    const SPEECH_COOLDOWN = 3000; 
    const SLOW_CYCLE_MS = 7000;
    const MONSTERS = [["üëæ", 300], ["ü¶á", 500], ["üëª", 800], ["üëπ", 1200], ["üê≤", 2000]];

    let appState = { exercise: "", subMode: "", isRunning: false, isFinished: false, isCameraReady: false, startTime: null, repStart: 0, patientID: "Guest" };
    let metrics = {
        count: 0, minAngle: 180, isDeep: false, isMoving: false, isClean: true,
        score: 0, combo: 0, maxCombo: 0, monsterLevel: 0, monsterHP: 0, defeated: 0, logs: [],
        isBalancing: false, balanceStart: 0, currentBalanceTime: 0, maxBalanceTime: 0,
        maxAngleL: 0, maxAngleR: 0
    };
    let surveyData = { rpe: 3, pain: "None" };
    let audioCtx = null;
    let lastSpeechTime = 0; 

    function getEl(id) { return document.getElementById(id); }
    const videoElement = getEl('input_video');
    const canvasElement = getEl('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // ‚òÖ ‰øÆÊ≠£: ‰∏çË∂≥„Åó„Å¶„ÅÑ„ÅüDOMË¶ÅÁ¥†„Çíels„Å´ËøΩÂä†
    const els = {
        uiSquat: getEl('squat-ui'), uiBalance: getEl('balance-ui'), uiBanzai: getEl('banzai-ui'),
        uiTraining: getEl('training-info'), uiGame: getEl('game-info'),
        
        depthGaugeContainer: getEl('depth-gauge-container'), // ËøΩÂä†
        depthBar: getEl('depth-bar'), targetLine: getEl('target-line'), targetLabel: getEl('target-label'),
        pacerGhost: getEl('pacer-ghost'), pacerContainer: getEl('pacer-container'),
        trReps: getEl('tr-reps'), trSpeed: getEl('tr-speed'), trTimer: getEl('tr-timer'), trPacerBox: getEl('tr-pacer-box'), trPacerVal: getEl('tr-pacer-val'),
        
        gmScoreBoard: getEl('gm-score-board'), gmScore: getEl('gm-score'), comboDisp: getEl('combo-display'),
        battleStage: getEl('battle-stage'), monster: getEl('monster'), monsterName: getEl('monster-name'), hpBar: getEl('hp-bar'), hpText: getEl('hp-text'),
        gmComboVal: getEl('gm-combo-val'), gmLvlVal: getEl('gm-lvl-val'),
        
        balTimer: getEl('bal-timer'), balStatus: getEl('bal-status'), balBest: getEl('bal-best'),
        bzAngleL: getEl('bz-angle-l'), bzAngleR: getEl('bz-angle-r'), bzBarL: getEl('banzai-bar-L'), bzBarR: getEl('banzai-bar-R'),
        
        statusLamp: getEl('status-lamp'), warningMsg: getEl('warning-msg'),
        countOverlay: getEl('countdown-overlay'), countVal: getEl('countdown-val'),
        startScreen: getEl('start-screen'), surveyScreen: getEl('survey-screen'), resScreen: getEl('result-screen'),
        genericMenu: getEl('generic-menu'), squatMenu: getEl('squat-menu'), measureMenu: getEl('measure-menu'), mainMenu: getEl('main-menu')
    };

    function initAudio() { if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if(audioCtx.state === 'suspended') audioCtx.resume(); }
    function playTone(freq, type, dur) { if(!audioCtx) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=0.1; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur); }
    function playSound(type) {
        if(!audioCtx) return;
        if(type==='count') playTone(600,'square',0.05);
        if(type==='start') { playTone(600,'square',0.1); setTimeout(()=>playTone(1200,'square',0.1),100); }
        if(type==='ok') { playTone(880,'sine',0.1); setTimeout(()=>playTone(1760,'sine',0.1),50); }
        if(type==='ng') playTone(150,'sawtooth',0.3);
        if(type==='crit') { playTone(880,'sine',0.1); setTimeout(()=>playTone(1760,'sine',0.2),50); }
        if(type==='hit') { playTone(400,'square',0.1); setTimeout(()=>playTone(600,'square',0.1),50); }
        if(type==='win') { playTone(523,'triangle',0.2); setTimeout(()=>playTone(659,'triangle',0.1),100); setTimeout(()=>playTone(784,'triangle',0.4),200); }
    }
    function speak(text, force = false) {
        const now = Date.now();
        if (force || (now - lastSpeechTime > SPEECH_COOLDOWN)) {
            const uttr = new SpeechSynthesisUtterance(text); uttr.lang = 'ja-JP'; uttr.rate = 1.2; window.speechSynthesis.speak(uttr); lastSpeechTime = now;
        }
    }
    function getNowStr() { return new Date().toLocaleString(); }
    function calculateAngle(a, b, c) { const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x); let angle = Math.abs(radians * 180.0 / Math.PI); if (angle > 180.0) angle = 360 - angle; return angle; }
    function fireConfetti() { confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 }, colors: ['#ffd700', '#00e676', '#2979ff'] }); }
    function showComboEffect(val) { els.comboDisp.innerText = val + " COMBO!"; els.comboDisp.classList.add("combo-active"); playSound('hit'); setTimeout(() => els.comboDisp.classList.remove("combo-active"), 800); }

    function updateRPE(val) { document.getElementById('rpe-val').innerText = val; surveyData.rpe = val; }
    function setPain(val, btn) { surveyData.pain = val; document.querySelectorAll('.pain-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }

    // Game Logic
    function spawnMonster() { let lv = metrics.monsterLevel; if(lv >= MONSTERS.length) lv = MONSTERS.length - 1; const m = MONSTERS[lv]; els.monster.innerText = m[0]; els.monsterName.innerText = `Lv.${lv+1} ${m[1]}`; metrics.monsterHP = m[1]; updateHP(m[1], m[1]); }
    function updateHP(cur, max) { const p = (cur / max) * 100; els.hpBar.style.width = p + "%"; els.hpText.innerText = `${cur} / ${max}`; }
    function updateScore(val) { metrics.score += val; els.gmScore.innerText = metrics.score; }
    function damageEffect(dmg, isCrit) {
        metrics.monsterHP -= dmg; if(metrics.monsterHP < 0) metrics.monsterHP = 0; updateHP(metrics.monsterHP, MONSTERS[Math.min(metrics.monsterLevel, 4)][1]);
        els.monster.classList.remove('damage-shake'); void els.monster.offsetWidth; els.monster.classList.add('damage-shake');
        if(isCrit) { playSound('crit'); fireConfetti(); } else { playSound('hit'); }
        if(metrics.monsterHP <= 0) { setTimeout(() => { playSound('win'); speak("ÊíÉÁ†¥ÔºÅ"); metrics.monsterLevel++; metrics.defeated++; spawnMonster(); }, 500); }
    }

    // Flow Control
    function selectCategory(cat) {
        appState.exercise = cat;
        if(cat === 'squat') {
            getEl('main-menu').style.display = 'none'; getEl('squat-menu').style.display = 'flex';
            setSquatMode('slow'); 
        } else if(cat === 'measure') {
            getEl('main-menu').style.display = 'none'; getEl('measure-menu').style.display = 'flex';
        }
    }

    function setSquatMode(mode) {
        appState.subMode = mode;
        ['slow','self','cs30','game'].forEach(m => getEl('opt-'+m).classList.remove('selected'));
        getEl('opt-'+mode).classList.add('selected');
    }
    
    function setMode(ex, sub) {
        appState.exercise = ex; appState.subMode = sub;
        const container = els.measureMenu;
        const btns = container.getElementsByClassName('sub-btn');
        for(let b of btns) b.classList.remove('selected');
        const btn = document.getElementById('opt-'+(ex==='squat'?'cs30':ex));
        if(btn) btn.classList.add('selected');
    }
    
    function backToMain() {
        getEl('squat-menu').style.display = 'none'; getEl('measure-menu').style.display = 'none';
        getEl('main-menu').style.display = 'flex';
    }
    
    function startApp() {
        appState.patientID = getEl('patient-id').value || "Guest";
        els.startScreen.style.display = 'none';
        initAudio(); speak("„Ç´„É°„É©„ÇíËµ∑Âãï„Åó„Åæ„Åô");
        
        els.uiSquat.style.display = 'none'; els.uiBalance.style.display = 'none'; els.uiBanzai.style.display = 'none';
        
        if(appState.exercise === 'squat') {
            els.uiSquat.style.display = 'block';
            if(appState.subMode === 'game') {
                els.uiGame.style.display = 'block'; els.uiTraining.style.display = 'none'; spawnMonster();
            } else {
                els.uiTraining.style.display = 'block'; els.uiGame.style.display = 'none';
                els.trTimer.style.display = (appState.subMode === 'cs30') ? 'block' : 'none';
                els.trPacerBox.style.display = (appState.subMode === 'slow') ? 'block' : 'none';
            }
            els.pacerContainer.style.display = (appState.subMode === 'cs30') ? 'none' : 'block';
        } else if(appState.exercise === 'balance') {
            els.uiBalance.style.display = 'block';
        } else {
            els.uiBanzai.style.display = 'block';
        }

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶„Ç´„É°„É©„Çí‰øùÊåÅ
        if(!window.camera) {
            window.camera = new Camera(videoElement, {
                onFrame: async () => { if(!appState.isFinished) await pose.send({image: videoElement}); },
                width: 1280, height: 720
            });
            window.camera.start();
        }
        if(appState.exercise === 'squat') animatePacerLoop();
    }

    function runCountdown() {
        let c = 5; els.countOverlay.style.display = 'flex'; els.countVal.innerText = c; playSound('count');
        const timer = setInterval(() => {
            c--; els.countVal.innerText = c; if(c > 0) playSound('count');
            if(c <= 0) {
                clearInterval(timer); els.countVal.innerText = "START!"; playSound('start');
                setTimeout(() => { els.countOverlay.style.display = 'none'; appState.startTime = Date.now(); appState.isRunning = true; }, 1000);
            }
        }, 1000);
    }

    function finishSession() {
        appState.isFinished = true; appState.isRunning = false;
        speak("ÁµÇ‰∫Ü„Åß„Åô"); document.querySelector('.container').style.display = 'none'; els.surveyScreen.style.display = 'flex';
    }

    function submitSurvey() {
        els.surveyScreen.style.display = 'none'; els.resScreen.style.display = 'flex';
        
        if(appState.exercise === 'squat') {
            getEl('res-squat-area').style.display = 'block'; getEl('res-simple-area').style.display = 'none';
            getEl('res-reps').innerText = metrics.count;
            if(appState.subMode === 'game') {
                getEl('game-result-area').style.display = 'block'; getEl('res-score-final').innerText = metrics.score;
                let r="B"; if(metrics.score>metrics.count*120)r="S"; else if(metrics.score>metrics.count*100)r="A"; getEl('res-rank').innerText = r;
            } else { getEl('game-result-area').style.display = 'none'; }

            const lbls = metrics.logs.map(d => d.rep);
            const spds = metrics.logs.map(d => d.duration);
            const dpts = metrics.logs.map(d => d.depth);
            const clrs = metrics.logs.map(d => (d.note==="Perfect")?'#00e676':'#ff1744');
            new Chart(getEl('speedChart'), {type:'line', data:{labels:lbls, datasets:[{label:'ÁßíÊï∞', data:spds, borderColor:'#00e676', tension:0.3}] }});
            new Chart(getEl('depthChart'), {type:'bar', data:{labels:lbls, datasets:[{label:'Ê∑±„Åï', data:dpts, backgroundColor:clrs}]}, options:{scales:{y:{reverse:true, min:60, max:180}}}});
            if(metrics.logs.length >= 6) {
                const f = metrics.logs.slice(0,3).reduce((a,b)=>a+b.duration,0)/3;
                const l = metrics.logs.slice(-3).reduce((a,b)=>a+b.duration,0)/3;
                getEl('res-fatigue').innerText = (l/f).toFixed(2);
            }
        } else {
            getEl('res-squat-area').style.display = 'none'; getEl('res-simple-area').style.display = 'block';
            if(appState.exercise === 'balance') {
                getEl('res-simple-label').innerText = "ÊúÄÂ§ß„Éê„É©„É≥„ÇπÊôÇÈñì";
                getEl('res-simple-val').innerText = metrics.maxBalanceTime.toFixed(2) + " s";
            } else {
                getEl('res-simple-label').innerText = "ÊúÄÂ§ßÂèØÂãïÂüü (L/R)";
                getEl('res-simple-val').innerText = `${Math.floor(metrics.maxAngleL)}¬∞ / ${Math.floor(metrics.maxAngleR)}¬∞`;
            }
        }
    }

    function animatePacerLoop() {
        if(!appState.isFinished && appState.subMode === 'slow') {
            if(appState.isRunning && appState.startTime) {
                const t = (Date.now() - appState.startTime) % SLOW_CYCLE_MS; let pos = 0;
                if(t < 3000) pos = 100 - (t/3000*100); else if(t < 6000) pos = (t-3000)/3000*100; else pos = 100;
                els.pacerGhost.style.top = pos + "%";
                const cycles = Math.floor((Date.now() - appState.startTime) / SLOW_CYCLE_MS);
                els.trPacerVal.innerText = cycles;
            } else { els.pacerGhost.style.top = "100%"; }
            requestAnimationFrame(animatePacerLoop);
        }
    }
    
    function checkBalance(lAnkle, rAnkle) {
        const diff = Math.abs(lAnkle.y - rAnkle.y);
        if(diff > 0.05) {
            if(!metrics.isBalancing) { metrics.isBalancing = true; metrics.balanceStart = Date.now(); speak("Ë®àÊ∏¨‰∏≠"); els.balStatus.innerText="Ë®àÊ∏¨‰∏≠"; els.balStatus.style.color="#00e676"; }
            const t = (Date.now() - metrics.balanceStart) / 1000;
            metrics.currentBalanceTime = t;
            if(t > metrics.maxBalanceTime) metrics.maxBalanceTime = t;
            els.balTimer.innerText = t.toFixed(2);
        } else {
            if(metrics.isBalancing) { metrics.isBalancing = false; speak("„Çπ„Éà„ÉÉ„Éó"); els.balStatus.innerText="Ë∂≥„Çí„Å§„Åç„Åæ„Åó„Åü"; els.balStatus.style.color="#ff1744"; els.balBest.innerText=metrics.maxBalanceTime.toFixed(2); }
        }
    }

    function checkBanzai(sL, eL, sR, eR, hL, hR) {
        const angL = calculateAngle(hL, sL, eL); const angR = calculateAngle(hR, sR, eR);
        if(angL > metrics.maxAngleL) metrics.maxAngleL = angL; if(angR > metrics.maxAngleR) metrics.maxAngleR = angR;
        els.bzAngleL.innerText = Math.floor(angL) + "¬∞"; els.bzAngleR.innerText = Math.floor(angR) + "¬∞";
        els.bzBarL.style.height = (angL / 180 * 100) + "%"; els.bzBarR.style.height = (angR / 180 * 100) + "%";
    }

    function onResults(results) {
        if(appState.isFinished) return;
        
        // „Ç´„É°„É©Ê∫ñÂÇôÂÆå‰∫ÜÊ§úÁü•
        if(!appState.isCameraReady) {
            appState.isCameraReady = true;
            if(appState.exercise === 'squat') {
                els.depthGaugeContainer.style.display = 'block'; 
                els.targetLabel.style.display = 'block';
                // „Çπ„É≠„Éà„É¨„Å®„Çª„É´„Éï„Å™„Çâ„Éö„Éº„Çµ„ÉºË°®Á§∫
                if(appState.subMode === 'slow' || appState.subMode === 'self') els.pacerContainer.style.display='block';
                
                const needsCount = (appState.subMode==='game' || appState.subMode==='cs30' || appState.subMode==='slow');
                if(needsCount) runCountdown();
                else {
                    appState.startTime = Date.now();
                    appState.isRunning = true;
                    speak("„Çπ„Çø„Éº„Éà");
                }
            } else {
                appState.isRunning = true; speak("Ë®àÊ∏¨„ÇíÈñãÂßã„Åó„Åæ„Åô");
            }
        }

        canvasElement.width = videoElement.videoWidth; canvasElement.height = videoElement.videoHeight;
        canvasCtx.save(); canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            const lms = results.poseLandmarks;
            // ‚òÖ È™®Ê†º„Éû„Éº„Ç´„Éº„ÇíÊúÄÂÑ™ÂÖà„ÅßÊèèÁîª
            drawConnectors(canvasCtx, lms, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
            drawLandmarks(canvasCtx, lms, {color: '#FF0000', lineWidth: 2});

            if(appState.exercise === 'balance') {
                if(lms[27].visibility > 0.5 && lms[28].visibility > 0.5) checkBalance(lms[27], lms[28]);
            } else if(appState.exercise === 'banzai') {
                if(lms[11].visibility>0.5 && lms[23].visibility>0.5) checkBanzai(lms[11], lms[13], lms[12], lms[14], lms[23], lms[24]);
            } else {
                // Squat Logic
                let side="RIGHT", sIdx=12, hIdx=24, kIdx=26, aIdx=28;
                if(lms[11].visibility > lms[12].visibility) { side="LEFT"; sIdx=11; hIdx=23; kIdx=25; aIdx=27; }
                if(lms[sIdx].visibility > 0.5 && lms[hIdx].visibility > 0.5) {
                    const kneeAngle = calculateAngle(lms[hIdx], lms[kIdx], lms[aIdx]);
                    const hipAngle = calculateAngle(lms[sIdx], lms[hIdx], lms[kIdx]);
                    
                    // UI
                    const minAng=180, maxAng=70;
                    let p = (minAng - kneeAngle) / (minAng - maxAng) * 100; if(p<0)p=0; if(p>100)p=100;
                    els.depthBar.style.height = p + "%";
                    let tp = (minAng - DEPTH_THRESHOLD) / (minAng - maxAng) * 100; els.targetLine.style.top = tp + "%";
                    if(appState.subMode === 'self' || appState.subMode === 'game') els.pacerGhost.style.top = p + "%";

                    canvasCtx.beginPath(); canvasCtx.moveTo(lms[sIdx].x*canvasElement.width, lms[sIdx].y*canvasElement.height); canvasCtx.lineTo(lms[hIdx].x*canvasElement.width, lms[hIdx].y*canvasElement.height); canvasCtx.lineTo(lms[kIdx].x*canvasElement.width, lms[kIdx].y*canvasElement.height); canvasCtx.strokeStyle = "yellow"; canvasCtx.lineWidth = 5; canvasCtx.stroke();

                    let warning="", isKneeIn=false;
                    if(side==="RIGHT" && lms[kIdx].x > lms[aIdx].x + KNEE_IN_THRESHOLD) isKneeIn=true;
                    if(side==="LEFT" && lms[kIdx].x < lms[aIdx].x - KNEE_IN_THRESHOLD) isKneeIn=true;
                    if(isKneeIn && kneeAngle < 160) { if(metrics.isMoving && metrics.isClean) { warning="„Å≤„Åñ„ÇíÈñã„ÅÑ„Å¶ÔºÅ"; metrics.isClean=false; speak("„Å≤„Åñ"); playSound('ng'); } }
                    if(hipAngle < BAD_POSTURE_ANGLE && kneeAngle < 160) { if(metrics.isMoving && metrics.isClean) { warning="ËÉ∏„ÇíÂºµ„Å£„Å¶ÔºÅ"; metrics.isClean=false; speak("„ÇÄ„Å≠"); playSound('ng'); } }
                    if(warning) { els.warningMsg.innerText=warning; els.warningMsg.style.display='block'; } else { els.warningMsg.style.display='none'; }

                    if(appState.isRunning) {
                        if(kneeAngle < 165 && !metrics.isMoving) { metrics.isMoving=true; appState.repStart=Date.now(); metrics.minAngle=180; metrics.isDeep=false; metrics.isClean=true; }
                        if(metrics.isMoving) {
                            if(kneeAngle < metrics.minAngle) metrics.minAngle = kneeAngle;
                            if(kneeAngle < DEPTH_THRESHOLD) metrics.isDeep=true;
                            if(kneeAngle > RESET_ANGLE) {
                                if(metrics.isDeep) {
                                    metrics.count++;
                                    const dur = (Date.now()-appState.repStart)/1000;
                                    
                                    if(appState.subMode==='game') {
                                        let damage=0, isCrit=false;
                                        if(metrics.isClean) {
                                            metrics.combo++; if(metrics.combo>metrics.maxCombo) metrics.maxCombo=metrics.combo;
                                            if(metrics.minAngle<100) { damage=150+metrics.combo*10; isCrit=true; } else { damage=100+metrics.combo*5; }
                                            updateScore(damage); showComboEffect(metrics.combo);
                                        } else {
                                            metrics.combo=0; damage=10; updateScore(10); speak("„Åä„Åó„ÅÑ");
                                        }
                                        damageEffect(damage, isCrit);
                                        els.gmComboVal.innerText = metrics.combo;
                                    } else {
                                        els.trReps.innerText=metrics.count; els.trSpeed.innerText=dur.toFixed(2);
                                        if(metrics.isClean) speak("OK", true);
                                    }
                                    
                                    let note="Perfect"; if(warning) note="Error";
                                    metrics.logs.push({id:appState.patientID, time:getNowStr(), rep:metrics.count, depth:Math.floor(metrics.minAngle), duration:parseFloat(dur.toFixed(2)), note:note});
                                }
                                metrics.isMoving=false;
                            }
                        }
                    }
                    if(metrics.isDeep) { els.statusLamp.innerText="OK!"; els.statusLamp.className="status-lamp lamp-ready"; } else { els.statusLamp.innerText="„Åó„ÇÉ„Åå„ÇÄ"; els.statusLamp.className="status-lamp lamp-squat"; }
                }
            }
        }
        if(appState.subMode==='cs30' && appState.isRunning && !appState.isFinished) { const elap = (Date.now()-appState.startTime)/1000; let rem = 30-elap; if(rem<=0) { rem=0; finishSession(); } els.trTimer.innerText = Math.ceil(rem); }
        canvasCtx.restore();
    }

    function sendToGoogleSheets() {
        const btn=getEl('cloud-btn'); btn.innerText="ÈÄÅ‰ø°‰∏≠..."; btn.disabled=true;
        const sID = appState.patientID + "_" + Date.now();
        const fatigue = (appState.exercise==='squat') ? getEl('res-fatigue').innerText : "-";
        let scoreVal = metrics.score, maxVal = metrics.maxCombo;
        if(appState.exercise === 'balance') maxVal = metrics.maxBalanceTime;
        if(appState.exercise === 'banzai') scoreVal = (metrics.maxAngleL + metrics.maxAngleR) / 2; 
        const payload = {
            sessionID: sID,
            summary: {
                patientID: appState.patientID, date: getNowStr(),
                mode: appState.exercise + "_" + appState.subMode,
                reps: metrics.count, score: scoreVal,
                maxCombo: maxVal, fatigue: fatigue,
                rpe: surveyData.rpe, pain: surveyData.pain
            },
            logs: metrics.logs 
        };
        fetch(GAS_URL, {method:'POST', body:JSON.stringify(payload), headers:{"Content-Type":"text/plain"}})
        .then(()=>{alert("ÂÆå‰∫Ü"); btn.innerText="ÈÄÅ‰ø°Ê∏à„Åø";})
        .catch(e=>{alert("„Ç®„É©„Éº"); btn.disabled=false;});
    }

    function downloadCSV() {
        let c = "ID,Time,Rep,Depth,Duration,Note\n";
        metrics.logs.forEach(r => c += `${r.id},${r.time},${r.rep},${r.depth},${r.duration},${r.note}\n`);
        const a = document.createElement("a"); a.href = encodeURI("data:text/csv;charset=utf-8,"+c); a.download = "log.csv"; a.click();
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    pose.onResults(onResults);
</script>
</body>
</html>
